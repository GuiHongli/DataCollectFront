# 任务列表页面按钮优化说明

## 优化背景

在任务列表页面中，原本存在两个功能重复的按钮：
- **"刷新"按钮**: 重新加载任务列表数据
- **"刷新执行状态"按钮**: 只刷新任务的执行状态数据

这两个按钮的功能存在重叠，容易造成用户困惑，因此进行了优化合并。

## 优化内容

### 1. 按钮合并

**优化前**:
```vue
<el-button @click="loadData">
  <el-icon><Refresh /></el-icon>
  刷新
</el-button>
<el-button @click="refreshExecutionStatus" :loading="statusLoading">
  <el-icon><Refresh /></el-icon>
  刷新执行状态
</el-button>
```

**优化后**:
```vue
<el-button @click="refreshAllData" :loading="loading">
  <el-icon><Refresh /></el-icon>
  刷新
</el-button>
```

### 2. 方法优化

**优化前**:
- `loadData()`: 加载任务列表数据，同时调用`loadTaskExecutionStatus()`
- `refreshExecutionStatus()`: 只刷新执行状态数据

**优化后**:
- `refreshAllData()`: 统一刷新所有数据（包括任务列表和执行状态）
- 移除了`refreshExecutionStatus()`方法
- 移除了`statusLoading`状态变量

### 3. 功能说明

新的"刷新"按钮功能包括：
1. **重新加载任务列表**: 获取最新的任务基本信息（任务ID、名称、状态、创建时间等）
2. **更新执行状态**: 为每个任务加载最新的执行例次数据，计算执行进度
3. **更新分页信息**: 保持当前分页状态，确保数据一致性
4. **统一加载状态**: 使用单一的loading状态，避免状态混乱

## 技术实现

### 1. 方法实现
```javascript
// 刷新所有数据（包括任务列表和执行状态）
const refreshAllData = async () => {
  loading.value = true
  try {
    await loadData()
    ElMessage.success('数据刷新成功')
  } catch (error) {
    console.error('刷新数据失败:', error)
    ElMessage.error('刷新数据失败')
  } finally {
    loading.value = false
  }
}
```

### 2. 数据加载流程
```javascript
const loadData = async () => {
  loading.value = true
  try {
    // 1. 加载任务列表数据
    const params = {
      current: pagination.current,
      size: pagination.size,
    }
    const res = await request({
      url: '/collect-task/page',
      method: 'get',
      params,
    })
    tableData.value = res.data.records
    pagination.total = res.data.total
    
    // 2. 为每个任务加载执行状态数据
    await loadTaskExecutionStatus()
  } catch (error) {
    console.error('加载数据失败:', error)
  } finally {
    loading.value = false
  }
}
```

### 3. 执行状态计算
```javascript
const loadTaskExecutionStatus = async () => {
  try {
    const promises = tableData.value.map(async (task) => {
      // 获取任务的执行例次数据
      const res = await request({
        url: `/collect-task/${task.id}/execution-instances`,
        method: 'get',
      })
      
      const instances = res.data || []
      // 计算各种统计数据
      const totalCount = instances.length
      const successCount = instances.filter(instance => instance.result === 'SUCCESS').length
      const failedCount = instances.filter(instance => instance.result === 'FAILED').length
      const blockedCount = instances.filter(instance => instance.result === 'BLOCKED').length
      const runningCount = instances.filter(instance => instance.status === 'RUNNING').length
      const completedCount = instances.filter(instance => instance.status !== 'RUNNING').length
      
      // 更新任务数据
      task.totalCount = totalCount
      task.successCount = successCount
      task.failedCount = failedCount
      task.runningCount = runningCount
      task.completedCount = completedCount
    })
    
    await Promise.all(promises)
  } catch (error) {
    console.error('加载任务执行状态失败:', error)
  }
}
```

## 用户体验改进

### 1. 界面简化
- 减少了按钮数量，界面更加简洁
- 消除了用户对按钮功能的困惑
- 统一的刷新操作，符合用户习惯

### 2. 操作一致性
- 每次刷新都会获取完整的最新数据
- 避免了数据不一致的问题
- 确保显示的信息是最新的

### 3. 性能考虑
- 虽然每次刷新都会加载更多数据，但确保了数据的完整性
- 对于正在执行的任务，系统会自动每30秒刷新一次执行状态
- 用户手动刷新主要用于获取最新数据

## 自动刷新机制

系统还保留了自动刷新机制，确保正在执行的任务状态能够及时更新：

```javascript
// 启动自动刷新
const startAutoRefresh = () => {
  if (autoRefreshTimer) {
    clearInterval(autoRefreshTimer)
  }
  
  // 每30秒自动刷新一次执行状态
  autoRefreshTimer = setInterval(async () => {
    const hasRunningTask = tableData.value.some(task => task.status === 'RUNNING')
    if (hasRunningTask) {
      await loadTaskExecutionStatus()
    }
  }, 30000)
}
```

## 总结

通过这次优化：
1. **简化了用户界面**: 减少了重复的按钮，界面更加清晰
2. **统一了刷新逻辑**: 所有数据刷新都通过一个按钮完成
3. **提高了数据一致性**: 确保显示的数据是最新和完整的
4. **改善了用户体验**: 消除了用户对按钮功能的困惑
5. **保持了功能完整性**: 所有原有功能都得到保留

这次优化使任务列表页面的操作更加直观和高效，符合用户的使用习惯。
